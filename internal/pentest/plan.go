package pentest

import (
	"context"
	"encoding/json"
	"fmt"
	"strings"

	"mcpxray/internal/libmcp"
)

func (t *PentestTool) GeneratePentestPlan(ctx context.Context, tools []libmcp.Tool) (string, error) {
	prompt := t.GenerateSecurityTestPrompt(tools)
	fmt.Printf("Pentest plan prompt generated with length %v\n", len(prompt))
	response, err := t.llmClient.CallLLM(ctx, prompt)
	if err != nil {
		return "", err
	}
	return response, nil
}

// GenerateSecurityTestPrompt creates a general prompt for an LLM to generate security tests for any MCP
func (t *PentestTool) GenerateSecurityTestPrompt(tools []libmcp.Tool) string {
	var sb strings.Builder

	sb.WriteString("You are a security testing expert specializing in API and MCP (Model Context Protocol) security.\n\n")
	sb.WriteString("# Your Task\n")
	sb.WriteString("Analyze the provided MCP tool descriptions and input schemas, then generate a security test plan in YAML format.\n\n")
	sb.WriteString("Focus on the top 3-5 most critical security vulnerabilities that apply to these specific tools.\n\n")

	sb.WriteString("# Security Test Categories to Consider\n\n")
	sb.WriteString("Evaluate each tool and determine which of these vulnerabilities apply:\n\n")

	sb.WriteString("## 1. Injection Attacks\n")
	sb.WriteString("- SQL/NoSQL injection in query parameters\n")
	sb.WriteString("- Command injection in system parameters\n")
	sb.WriteString("- Code injection in executable parameters\n")
	sb.WriteString("- Path traversal in file/directory parameters\n")
	sb.WriteString("- LDAP/XML/template injection where applicable\n\n")

	sb.WriteString("## 2. Authentication & Authorization\n")
	sb.WriteString("- Missing authentication checks\n")
	sb.WriteString("- Privilege escalation attempts\n")
	sb.WriteString("- Cross-tenant/cross-user data access\n")
	sb.WriteString("- Token/credential leakage in responses\n")
	sb.WriteString("- Session/token manipulation\n\n")

	sb.WriteString("## 3. Server-Side Request Forgery (SSRF)\n")
	sb.WriteString("- Internal network access via URL parameters\n")
	sb.WriteString("- Cloud metadata service access (AWS, GCP, Azure)\n")
	sb.WriteString("- Localhost/127.0.0.1 access\n")
	sb.WriteString("- Private IP range access (10.x, 172.16.x, 192.168.x)\n")
	sb.WriteString("- Protocol smuggling (file://, gopher://, etc.)\n\n")

	sb.WriteString("## 4. Input Validation\n")
	sb.WriteString("- Oversized inputs causing DoS\n")
	sb.WriteString("- Special characters breaking parsing\n")
	sb.WriteString("- Unicode/encoding issues\n")
	sb.WriteString("- Null byte injection\n")
	sb.WriteString("- Format string vulnerabilities\n\n")

	sb.WriteString("## 5. Information Disclosure\n")
	sb.WriteString("- Sensitive data in error messages (tokens, passwords, keys)\n")
	sb.WriteString("- Stack traces revealing internal paths\n")
	sb.WriteString("- Debug information in responses\n")
	sb.WriteString("- Internal IP addresses or hostnames\n")
	sb.WriteString("- Database query details\n")
	sb.WriteString("- System/version information\n\n")

	sb.WriteString("## 6. Business Logic Flaws\n")
	sb.WriteString("- Rate limiting bypass\n")
	sb.WriteString("- Resource exhaustion\n")
	sb.WriteString("- Pagination abuse\n")
	sb.WriteString("- Mass operations without limits\n")
	sb.WriteString("- Workflow/state manipulation\n\n")

	sb.WriteString("# Output Format\n\n")
	sb.WriteString("Generate YAML following this structure:\n\n")
	sb.WriteString("```yaml\n")
	sb.WriteString("metadata:\n")
	sb.WriteString("  version: \"1.0\"\n")
	sb.WriteString("  target: \"[MCP Server Name]\"\n")
	sb.WriteString("  focus: \"Critical security vulnerabilities\"\n\n")
	sb.WriteString("tests:\n")
	sb.WriteString("  - test_id: \"SEC-001\"\n")
	sb.WriteString("    name: \"[Descriptive vulnerability name]\"\n")
	sb.WriteString("    purpose: |\n")
	sb.WriteString("      Explain what vulnerability this tests and why it's critical.\n")
	sb.WriteString("      Include potential impact if exploited.\n")
	sb.WriteString("    severity: \"CRITICAL\"  # CRITICAL, HIGH, MEDIUM, or LOW\n")
	sb.WriteString("    \n")
	sb.WriteString("    prerequisites:  # Optional - only if test needs setup\n")
	sb.WriteString("      - description: \"How to obtain this value\"\n")
	sb.WriteString("        variable: \"VARIABLE_NAME\"\n")
	sb.WriteString("    \n")
	sb.WriteString("    test_cases:\n")
	sb.WriteString("      - case_id: \"SEC-001-A\"\n")
	sb.WriteString("        description: \"Specific attack vector being tested\"\n")
	sb.WriteString("        input:\n")
	sb.WriteString("          tool: \"toolName\"\n")
	sb.WriteString("          arguments:\n")
	sb.WriteString("            param1: \"attack_payload\"\n")
	sb.WriteString("            param2: \"value\"\n")
	sb.WriteString("        expected_output:\n")
	sb.WriteString("          success: false\n")
	sb.WriteString("          error_present: true\n")
	sb.WriteString("          error_code_one_of: [400, 403, 404, -32602]\n")
	sb.WriteString("          error_message_contains_one_of:\n")
	sb.WriteString("            - \"invalid\"\n")
	sb.WriteString("            - \"forbidden\"\n")
	sb.WriteString("            - \"malformed\"\n")
	sb.WriteString("          result: null\n")
	sb.WriteString("```\n\n")

	sb.WriteString("# Expected Output Field Descriptions\n\n")
	sb.WriteString("- success: false (attack should fail), true (if testing information disclosure)\n")
	sb.WriteString("- error_present: true (should return error), false (should succeed but sanitize)\n")
	sb.WriteString("- error_code_one_of: List of acceptable error codes\n")
	sb.WriteString("- error_message_contains_one_of: Error must contain at least one of these phrases (case-insensitive)\n")
	sb.WriteString("- result: Expected result value, null if should not return data\n")
	sb.WriteString("- error_response_must_not_match_regex: Full response must NOT match these regex patterns\n")
	sb.WriteString("- error_response_must_not_contain: Full response must NOT contain these strings\n")
	sb.WriteString("- result_should_not_contain: If result present, should not contain these strings\n\n")

	sb.WriteString("# Test Generation Guidelines\n\n")
	sb.WriteString("## Prioritization\n")
	sb.WriteString("1. Rank tests by severity: CRITICAL > HIGH > MEDIUM > LOW\n")
	sb.WriteString("2. Focus on vulnerabilities that could lead to:\n")
	sb.WriteString("   - Data breaches or unauthorized access\n")
	sb.WriteString("   - System compromise or code execution\n")
	sb.WriteString("   - Denial of service\n")
	sb.WriteString("   - Privilege escalation\n")
	sb.WriteString("3. Limit to 3-5 tests total, with 3-5 test cases each\n\n")

	sb.WriteString("## Attack Payloads by Parameter Type\n\n")
	sb.WriteString("### URL/URI Parameters\n")
	sb.WriteString("Test with:\n")
	sb.WriteString("- http://169.254.169.254/latest/meta-data/ (AWS metadata)\n")
	sb.WriteString("- http://metadata.google.internal (GCP metadata)\n")
	sb.WriteString("- http://127.0.0.1:PORT (localhost)\n")
	sb.WriteString("- http://10.0.0.1 (private IP)\n")
	sb.WriteString("- file:///etc/passwd (local files)\n\n")

	sb.WriteString("### ID/Key Parameters\n")
	sb.WriteString("Test with:\n")
	sb.WriteString("- ../../../etc/passwd (path traversal)\n")
	sb.WriteString("- 00000000-0000-0000-0000-000000000000 (invalid UUID)\n")
	sb.WriteString("- 999999999 (non-existent ID)\n")
	sb.WriteString("- <script>alert('xss')</script> (injection)\n")
	sb.WriteString("- '; DROP TABLE x; -- (SQL injection)\n\n")

	sb.WriteString("### Query/Search Parameters\n")
	sb.WriteString("Test with:\n")
	sb.WriteString("- ' OR '1'='1 (basic injection)\n")
	sb.WriteString("- ' OR 1=1-- (comment-based)\n")
	sb.WriteString("- '; DROP TABLE x; -- (destructive)\n")
	sb.WriteString("- ' UNION SELECT * FROM users-- (union-based)\n\n")

	sb.WriteString("### Content/Body Parameters\n")
	sb.WriteString("Test with:\n")
	sb.WriteString("- <script>alert('XSS')</script> (XSS)\n")
	sb.WriteString("- <img src=x onerror=alert(1)> (XSS variant)\n")
	sb.WriteString("- javascript:alert(1) (protocol handler)\n")
	sb.WriteString("- $(whoami) (command injection)\n")
	sb.WriteString("- {{7*7}} (template injection)\n\n")

	sb.WriteString("### File/Path Parameters\n")
	sb.WriteString("Test with:\n")
	sb.WriteString("- ../../../etc/passwd (directory traversal)\n")
	sb.WriteString("- ..\\..\\..\\windows\\system32\\config\\sam (Windows)\n")
	sb.WriteString("- /etc/passwd (absolute path)\n")
	sb.WriteString("- file:///etc/passwd (file protocol)\n\n")

	sb.WriteString("## Information Disclosure Checks\n\n")
	sb.WriteString("For EVERY test, include at least one case checking for information leakage:\n\n")
	sb.WriteString("```yaml\n")
	sb.WriteString("expected_output:\n")
	sb.WriteString("  error_response_must_not_match_regex:\n")
	sb.WriteString("    - \"Bearer [a-zA-Z0-9_-]{20,}\"  # OAuth tokens\n")
	sb.WriteString("    - \"token[\\\"']?\\\\s*:\\\\s*[\\\"'][a-zA-Z0-9_-]{20,}\"  # Token fields\n")
	sb.WriteString("    - \"[a-zA-Z0-9_-]{32,}\"  # Long secrets\n")
	sb.WriteString("  error_response_must_not_contain:\n")
	sb.WriteString("    - \"/home/\"  # Unix paths\n")
	sb.WriteString("    - \"/usr/\"\n")
	sb.WriteString("    - \"/var/\"\n")
	sb.WriteString("    - \"C:\\\\\"  # Windows paths\n")
	sb.WriteString("    - \"at Object.\"  # Stack traces\n")
	sb.WriteString("    - \"at async\"\n")
	sb.WriteString("    - \"password\"\n")
	sb.WriteString("    - \"secret\"\n")
	sb.WriteString("    - \"api_key\"\n")
	sb.WriteString("    - \"127.0.0.1\"  # Internal IPs\n")
	sb.WriteString("    - \"localhost\"\n")
	sb.WriteString("    - \"node_modules\"\n")
	sb.WriteString("```\n\n")

	sb.WriteString("## Variable Substitution\n\n")
	sb.WriteString("Use ${VARIABLE_NAME} when tests need real/valid values. Declare in prerequisites:\n\n")
	sb.WriteString("```yaml\n")
	sb.WriteString("prerequisites:\n")
	sb.WriteString("  - description: \"Obtain from [tool_name] or user configuration\"\n")
	sb.WriteString("    variable: \"VALID_ID\"\n")
	sb.WriteString("```\n\n")

	sb.WriteString("# Tools to Analyze\n\n")

	// Add each tool with its schema
	for i, tool := range tools {
		sb.WriteString(fmt.Sprintf("## Tool %d: %s\n\n", i+1, tool.Name))
		desc := tool.Description
		if len(desc) > 1000 {
			desc = desc[:1000]
		}
		sb.WriteString(fmt.Sprintf("**Description:** %s\n\n", desc))

		// Format and include schema
		if len(tool.InputSchema) > 0 {
			var schema map[string]interface{}
			if err := json.Unmarshal(tool.InputSchema, &schema); err == nil {
				schemaJSON, _ := json.MarshalIndent(schema, "", "  ")
				sb.WriteString("**Input Schema:**\n```json\n")
				sb.WriteString(string(schemaJSON))
				sb.WriteString("\n```\n\n")
			}
		}
	}

	sb.WriteString("\n# Instructions\n\n")
	sb.WriteString("1. **Analyze each tool** for applicable vulnerabilities\n")
	sb.WriteString("2. **Select top 3 most critical** security tests\n")
	sb.WriteString("3. **Create 2 test cases** per test covering different attack vectors\n")
	sb.WriteString("4. **Be specific** with expected outputs - use exact error messages and regex patterns\n")
	sb.WriteString("5. **Use realistic attack payloads** appropriate for each parameter type\n")
	sb.WriteString("6. **Include information disclosure checks** in at least one test\n\n")

	sb.WriteString("# Output Requirements\n\n")
	sb.WriteString("- Generate ONLY valid YAML, no explanations or markdown\n")
	sb.WriteString("- Use the exact structure shown above\n")
	sb.WriteString("- Include specific attack payloads appropriate for each tool\n")
	sb.WriteString("- Specify precise expected outputs (error messages, regex patterns)\n")
	sb.WriteString("- Focus on realistic, high-impact vulnerabilities\n")
	sb.WriteString("- Each test must have a clear purpose explaining the security risk\n\n")

	sb.WriteString("BEGIN YAML OUTPUT:\n")

	return sb.String()
}
