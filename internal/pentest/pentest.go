package pentest

import (
	"context"
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"time"

	"mcpxray/internal/libmcp"
	"mcpxray/internal/llm"
	"mcpxray/internal/report"
	"mcpxray/internal/verify"
	"mcpxray/proto"

	"github.com/modelcontextprotocol/go-sdk/mcp"
)

type PentestTool struct {
	configPath   string
	llmClient    *llm.LLMClient
	verifyTool   *verify.VerifyTool
	session      *libmcp.SDKSession
	serverConfig *libmcp.MCPServerConfig
}

func NewPentestTool(configPath string, model string) (*PentestTool, error) {
	var llmClient *llm.LLMClient
	var err error
	if model != "" {
		llmClient, err = llm.NewLLMClientFromEnvWithModel(model, 30*time.Second)
		if err != nil {
			return nil, err
		}
	}

	verifyTool, err := verify.NewVerifyTool(configPath, model)
	if err != nil {
		return nil, err
	}

	return &PentestTool{
		configPath: configPath,
		llmClient:  llmClient,
		verifyTool: verifyTool,
	}, nil
}

func (t *PentestTool) Pentest(ctx context.Context, testPlanPath string) ([]*proto.Finding, error) {
	// Parse configPath
	servers, err := libmcp.NewConfigParser(t.configPath).Parse()
	if err != nil {
		return nil, err
	}

	// Check if testPlanPath is a file or directory
	testPlanInfo, err := os.Stat(testPlanPath)
	isFile := false
	if err == nil {
		isFile = !testPlanInfo.IsDir()
	}

	var allFindings []*proto.Finding

	for _, server := range servers {
		// Cache server config and create initial session
		t.serverConfig = &server
		session, err := libmcp.NewSDKSession(ctx, server)
		if err != nil {
			fmt.Printf("Skipping server %s: Failed to create SDK session: %v\n", server.Name, err)
			continue
		}
		t.session = session
		defer func() {
			if t.session != nil {
				_ = t.session.Close()
			}
		}()

		// Get tools using SDK
		toolsList, err := t.session.Session.ListTools(ctx, &mcp.ListToolsParams{})
		if err != nil {
			return nil, err
		}
		tools := toolsList.Tools

		if len(tools) == 0 {
			continue
		}

		var testPlanFile string

		if isFile {
			// Use the single test plan file for all servers
			testPlanFile = testPlanPath
		} else {
			// Generate test plan file path for this server in the directory
			testPlanFile = filepath.Join(testPlanPath, fmt.Sprintf("pentest_plan_%s_%s.yaml", server.Name, time.Now().Format(time.RFC3339)))

			// Check if test plan file exists, if not generate it
			if _, err := os.Stat(testPlanFile); os.IsNotExist(err) {
				// Convert []*mcp.Tool to []mcp.Tool
				toolsSlice := make([]mcp.Tool, len(tools))
				for i, tool := range tools {
					toolsSlice[i] = *tool
				}

				fileContent, err := t.GeneratePentestPlan(ctx, toolsSlice, server.Name)
				if err != nil {
					return nil, fmt.Errorf("failed to generate pentest plan: %w", err)
				}
				err = os.WriteFile(testPlanFile, []byte(fileContent), 0644)
				if err != nil {
					return nil, fmt.Errorf("failed to write pentest plan to file: %w", err)
				}
			}
		}

		preliminaryFindings, err := t.ExecuteTestPlan(ctx, testPlanFile, server.Name)
		if err != nil {
			return nil, fmt.Errorf("failed to execute pentest plan: %w", err)
		}

		// Write preliminary findings to disk
		if err := t.writePreliminaryFindings(preliminaryFindings, server.Name); err != nil {
			return nil, fmt.Errorf("failed to write preliminary findings: %w", err)
		}

		findings, err := t.verifyTool.VerifyFindings(ctx, preliminaryFindings)
		if err != nil {
			return nil, fmt.Errorf("failed to verify findings: %w", err)
		}
		allFindings = append(allFindings, findings...)

		// Clear session for next server
		if t.session != nil {
			_ = t.session.Close()
			t.session = nil
		}
		t.serverConfig = nil
	}

	return allFindings, nil
}

// writePreliminaryFindings writes preliminary findings to disk in SARIF format
func (t *PentestTool) writePreliminaryFindings(findings []*proto.Finding, serverName string) error {
	if len(findings) == 0 {
		return nil
	}

	// Generate SARIF report
	sarifBytes, err := report.GenerateSarif(findings)
	if err != nil {
		return fmt.Errorf("error generating SARIF report: %w", err)
	}

	// Generate output filename
	timestamp := time.Now().Format(time.RFC3339)
	timestamp = strings.ReplaceAll(timestamp, ":", "-")
	outputPath := fmt.Sprintf("preliminary-findings-%s-%s.sarif.json", serverName, timestamp)

	// Write to file
	err = os.WriteFile(outputPath, sarifBytes, 0644)
	if err != nil {
		return fmt.Errorf("error writing to output file %s: %w", outputPath, err)
	}

	fmt.Printf("Preliminary findings written to %s\n", outputPath)
	return nil
}

// getSession returns the cached session, creating it if necessary or recreating it if needed
func (t *PentestTool) getSession(ctx context.Context) (*mcp.ClientSession, error) {
	if t.session != nil {
		return t.session.Session, nil
	}
	if t.serverConfig == nil {
		return nil, fmt.Errorf("server config not set")
	}
	sdkSession, err := libmcp.NewSDKSession(ctx, *t.serverConfig)
	if err != nil {
		return nil, fmt.Errorf("failed to create session: %w", err)
	}
	t.session = sdkSession
	return t.session.Session, nil
}
