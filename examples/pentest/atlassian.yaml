metadata:
  version: "1.0"
  target: "Confluence MCP Server - getConfluencePage"
  focus: "Critical security vulnerabilities in page retrieval and cloud ID handling"

tests:
  - test_id: "SEC-001"
    name: "Server-Side Request Forgery (SSRF) via cloudId URL Parameter"
    purpose: |
      Tests if the cloudId parameter can be exploited to access internal resources
      when accepting URLs. The tool accepts site URLs and converts them to cloud IDs,
      which could be exploited to probe internal networks, cloud metadata services,
      or local file systems. Critical impact: Could expose AWS/GCP credentials,
      internal service endpoints, or sensitive configuration data.
    severity: "CRITICAL"
    
    test_cases:
      - case_id: "SEC-001-A"
        description: "Attempt to access AWS metadata service via cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
            pageId: "123456789"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "unauthorized"
            - "forbidden"
            - "malformed"
          result: null
          error_response_must_not_contain:
            - "AccessKeyId"
            - "SecretAccessKey"
            - "Token"
            - "iam"
            - "credentials"
      
      - case_id: "SEC-001-B"
        description: "Attempt to access localhost services via cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://127.0.0.1:8080/admin"
            pageId: "123456789"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "forbidden"
          result: null
          error_response_must_not_contain:
            - "127.0.0.1"
            - "localhost"
            - "admin"
      
      - case_id: "SEC-001-C"
        description: "Attempt to access internal private network via cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://10.0.0.1/internal"
            pageId: "123456789"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "forbidden"
          result: null
          error_response_must_not_contain:
            - "10.0.0"
            - "192.168."
            - "172.16."
      
      - case_id: "SEC-001-D"
        description: "Attempt file protocol access via cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "file:///etc/passwd"
            pageId: "123456789"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "forbidden"
          result: null
          error_response_must_not_contain:
            - "root:"
            - "/bin/bash"
            - "/etc/"

  - test_id: "SEC-002"
    name: "Path Traversal and Injection via pageId Parameter"
    purpose: |
      Tests if the pageId parameter is vulnerable to path traversal or injection attacks
      that could allow access to unauthorized pages or trigger backend injection vulnerabilities.
      Critical impact: Could expose sensitive pages from other workspaces, trigger SQL/NoSQL
      injection in backend queries, or bypass authorization checks.
    severity: "CRITICAL"
    
    test_cases:
      - case_id: "SEC-002-A"
        description: "Path traversal attempt in pageId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "../../../admin/sensitive"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "forbidden"
          result: null
      
      - case_id: "SEC-002-B"
        description: "SQL injection attempt in pageId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123' OR '1'='1"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null
          error_response_must_not_match_regex:
            - "SELECT.*FROM"
            - "sql.*syntax"
            - "mysql.*error"
            - "postgresql.*error"
      
      - case_id: "SEC-002-C"
        description: "NoSQL injection attempt in pageId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "{'$ne': null}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null
      
      - case_id: "SEC-002-D"
        description: "Command injection attempt in pageId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123; whoami; echo"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null

  - test_id: "SEC-003"
    name: "Information Disclosure in Error Messages"
    purpose: |
      Tests whether error messages expose sensitive information such as internal paths,
      API tokens, stack traces, database details, or system configuration. 
      High impact: Leaked information can aid attackers in crafting more targeted attacks,
      expose authentication tokens, or reveal internal architecture.
    severity: "HIGH"
    
    prerequisites:
      - description: "Obtain a valid Atlassian Cloud ID from getAccessibleAtlassianResources tool or site URL"
        variable: "VALID_CLOUD_ID"
    
    test_cases:
      - case_id: "SEC-003-A"
        description: "Trigger error with invalid pageId to check for stack trace leakage"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "00000000-0000-0000-0000-000000000000"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_response_must_not_contain:
            - "at Object."
            - "at async"
            - "node_modules"
            - "/home/"
            - "/usr/"
            - "/var/"
            - "C:\\"
            - ".js:"
            - "Error:"
          error_response_must_not_match_regex:
            - "Bearer [a-zA-Z0-9_-]{20,}"
            - "token[\"']?\\s*:\\s*[\"'][a-zA-Z0-9_-]{20,}"
            - "[a-fA-F0-9]{32,}"
            - "/[a-z]+/[a-z]+/[a-z]+\\.js:\\d+"
      
      - case_id: "SEC-003-B"
        description: "Trigger error with malformed cloudId to check for credential leakage"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "invalid-cloud-id-format-test"
            pageId: "123456789"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 404, -32602]
          error_response_must_not_contain:
            - "api_key"
            - "apiKey"
            - "secret"
            - "password"
            - "token"
            - "Bearer"
            - "authorization"
            - "127.0.0.1"
            - "localhost"
          error_response_must_not_match_regex:
            - "api[_-]?key[\"']?\\s*[:=]\\s*[\"']?[a-zA-Z0-9]{20,}"
            - "secret[\"']?\\s*[:=]\\s*[\"']?[a-zA-Z0-9]{20,}"
      
      - case_id: "SEC-003-C"
        description: "Test oversized pageId for DoS and error handling"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "${'A' * 10000}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 413, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "too large"
            - "exceeded"
            - "malformed"
          error_response_must_not_contain:
            - "OutOfMemory"
            - "heap"
            - "FATAL"

  - test_id: "SEC-004"
    name: "Cross-Tenant Data Access via Cloud ID Manipulation"
    purpose: |
      Tests if authorization checks properly prevent access to pages in other
      Atlassian Cloud instances by manipulating the cloudId parameter.
      High impact: Could lead to unauthorized cross-tenant data access,
      exposing confidential information from other organizations.
    severity: "HIGH"
    
    prerequisites:
      - description: "Obtain a valid Cloud ID that the user has access to"
        variable: "VALID_CLOUD_ID"
      - description: "Obtain a valid page ID that exists in VALID_CLOUD_ID"
        variable: "VALID_PAGE_ID"
    
    test_cases:
      - case_id: "SEC-004-A"
        description: "Attempt access with arbitrary UUID cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [401, 403, 404, -32602]
          error_message_contains_one_of:
            - "unauthorized"
            - "forbidden"
            - "not found"
            - "access denied"
          result: null
      
      - case_id: "SEC-004-B"
        description: "Attempt to access page with modified cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "00000000-0000-0000-0000-000000000001"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [401, 403, 404, -32602]
          error_message_contains_one_of:
            - "unauthorized"
            - "forbidden"
            - "not found"
            - "access denied"
          result: null
      
      - case_id: "SEC-004-C"
        description: "Test for privilege escalation by accessing restricted page"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "999999999"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [401, 403, 404, -32602]
          error_message_contains_one_of:
            - "unauthorized"
            - "forbidden"
            - "not found"
            - "access denied"
          result: null
          error_response_must_not_contain:
            - "body"
            - "content"
            - "title"